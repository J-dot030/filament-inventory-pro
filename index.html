<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Filament AI Inventory</title>
    <!-- Tailwind CSS for Professional Graphics -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#3b82f6', 600: '#2563eb' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .scan-region-highlight { border: 2px solid #3b82f6 !important; box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="glass-panel sticky top-0 z-40 px-4 py-3 flex justify-between items-center border-b border-slate-700 shadow-lg">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-lg shadow-brand-500/30">
                <i class="fa-solid fa-cube text-white"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight text-white">Filament<span class="text-brand-500">Pro</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="exportData()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-download"></i></button>
            <button onclick="openSettings()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-gear"></i></button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 p-4 max-w-2xl mx-auto w-full space-y-6 pb-24">

        <!-- Stats Row -->
        <div class="grid grid-cols-2 gap-3">
            <div class="glass-panel p-4 rounded-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                    <i class="fa-solid fa-layer-group text-4xl"></i>
                </div>
                <span class="text-slate-400 text-xs uppercase font-bold tracking-wider">Total Spools</span>
                <div class="flex items-baseline gap-1 mt-1">
                    <span id="total-spools" class="text-3xl font-bold text-white">0</span>
                    <span class="text-xs text-slate-500">units</span>
                </div>
            </div>
            <div class="glass-panel p-4 rounded-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition">
                    <i class="fa-solid fa-triangle-exclamation text-4xl text-amber-500"></i>
                </div>
                <span class="text-slate-400 text-xs uppercase font-bold tracking-wider">Low Stock</span>
                <div class="flex items-baseline gap-1 mt-1">
                    <span id="low-stock-count" class="text-3xl font-bold text-amber-500">0</span>
                    <span class="text-xs text-amber-500/70">items</span>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="relative">
            <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="search-input" onkeyup="renderInventory()" placeholder="Search brand, color, type..." 
                class="w-full bg-slate-800/80 border border-slate-700 rounded-xl py-3 pl-11 pr-4 text-white focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition-all placeholder-slate-500">
        </div>

        <!-- Filter Chips -->
        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar" id="filter-chips">
            <button onclick="filterType('all')" class="px-4 py-1.5 rounded-full bg-brand-600 text-white text-sm font-medium whitespace-nowrap shadow-lg shadow-brand-500/20">All</button>
            <button onclick="filterType('PLA')" class="px-4 py-1.5 rounded-full bg-slate-800 text-slate-300 text-sm font-medium whitespace-nowrap border border-slate-700 hover:bg-slate-700">PLA</button>
            <button onclick="filterType('PETG')" class="px-4 py-1.5 rounded-full bg-slate-800 text-slate-300 text-sm font-medium whitespace-nowrap border border-slate-700 hover:bg-slate-700">PETG</button>
            <button onclick="filterType('ABS')" class="px-4 py-1.5 rounded-full bg-slate-800 text-slate-300 text-sm font-medium whitespace-nowrap border border-slate-700 hover:bg-slate-700">ABS</button>
        </div>

        <!-- Inventory Grid -->
        <div id="inventory-grid" class="space-y-3">
            <!-- Items will be injected here -->
        </div>

    </main>

    <!-- Floating Action Buttons (FAB) -->
    <div class="fixed bottom-6 left-0 w-full px-4 flex justify-center gap-3 z-30">
        <!-- Scan QR Button -->
        <button onclick="startQrScanner()" class="flex-1 max-w-[160px] bg-slate-800 hover:bg-slate-700 text-white py-3.5 px-6 rounded-2xl shadow-xl border border-slate-600 flex items-center justify-center gap-2 transition active:scale-95">
            <i class="fa-solid fa-qrcode"></i>
            <span class="font-bold">Scan QR</span>
        </button>
        
        <!-- AI Scan Button -->
        <button onclick="openAICamera()" class="flex-1 max-w-[160px] bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white py-3.5 px-6 rounded-2xl shadow-xl shadow-brand-500/30 flex items-center justify-center gap-2 transition active:scale-95 border border-white/10">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            <span class="font-bold">AI Scan</span>
        </button>
    </div>

    <!-- Modals -->

    <!-- QR Scanner Modal -->
    <div id="qr-modal" class="fixed inset-0 z-50 bg-black hidden flex-col">
        <div class="p-4 flex justify-between items-center bg-black/60 absolute top-0 w-full z-10 backdrop-blur-sm">
            <h3 class="text-white font-bold">Scan Barcode/QR</h3>
            <button onclick="stopQrScanner()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="reader" class="flex-1 w-full bg-black"></div>
    </div>

    <!-- AI Camera Modal -->
    <div id="ai-modal" class="fixed inset-0 z-50 bg-black hidden flex-col">
        <div class="p-4 flex justify-between items-center bg-black/60 absolute top-0 w-full z-10 backdrop-blur-sm">
            <h3 class="text-white font-bold">AI Box Scanner</h3>
            <button onclick="closeAICamera()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="relative flex-1 bg-black flex items-center justify-center overflow-hidden">
            <video id="ai-video" autoplay playsinline class="w-full h-full object-cover opacity-80"></video>
            <canvas id="ai-canvas" class="hidden"></canvas>
            
            <!-- Guides -->
            <div class="absolute inset-0 border-2 border-white/30 m-8 rounded-3xl pointer-events-none flex items-center justify-center">
                <p class="text-white/70 text-sm font-medium bg-black/50 px-3 py-1 rounded-full">Place box front in frame</p>
            </div>

            <!-- Shutter -->
            <button onclick="captureAndAnalyze()" class="absolute bottom-12 w-20 h-20 rounded-full border-4 border-white/50 flex items-center justify-center bg-white/20 active:bg-white/40 transition backdrop-blur-sm">
                <div class="w-16 h-16 bg-white rounded-full shadow-lg"></div>
            </button>
            
            <!-- Loading AI -->
            <div id="ai-loading" class="absolute inset-0 bg-black/90 hidden flex-col items-center justify-center z-20 backdrop-blur-md">
                <div class="relative w-16 h-16">
                    <div class="absolute inset-0 border-4 border-brand-500/30 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-brand-500 rounded-full border-t-transparent animate-spin"></div>
                </div>
                <h3 class="text-white font-bold text-lg mt-6">Analyzing Image...</h3>
                <p class="text-brand-400 text-sm mt-1 animate-pulse">Consulting Gemini AI</p>
            </div>
        </div>
    </div>

    <!-- Item Editor Modal -->
    <div id="item-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden items-end sm:items-center justify-center p-4 transition-all">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-3xl p-6 shadow-2xl relative animate-[slideUp_0.3s_ease-out]">
            <button onclick="closeItemModal()" class="absolute top-5 right-5 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            
            <h3 id="modal-title" class="text-xl font-bold text-white mb-6">Edit Filament</h3>
            
            <div class="space-y-5">
                <input type="hidden" id="item-id">
                
                <div class="space-y-1">
                    <label class="text-slate-400 text-xs uppercase font-bold tracking-wider ml-1">Brand Name</label>
                    <div class="relative">
                        <i class="fa-solid fa-tag absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="text" id="item-brand" class="w-full bg-slate-800 border border-slate-700 rounded-xl py-3.5 pl-11 pr-4 text-white focus:border-brand-500 outline-none transition">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-slate-400 text-xs uppercase font-bold tracking-wider ml-1">Material</label>
                        <select id="item-type" class="w-full bg-slate-800 border border-slate-700 rounded-xl py-3.5 px-4 text-white focus:border-brand-500 outline-none appearance-none">
                            <option value="PLA">PLA</option>
                            <option value="PLA+">PLA+</option>
                            <option value="PETG">PETG</option>
                            <option value="ABS">ABS</option>
                            <option value="ASA">ASA</option>
                            <option value="TPU">TPU</option>
                            <option value="Nylon">Nylon</option>
                            <option value="Unknown">Other</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-slate-400 text-xs uppercase font-bold tracking-wider ml-1">Color</label>
                        <div class="relative">
                            <span id="color-preview" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 rounded-full border border-slate-600 bg-white"></span>
                            <input type="text" id="item-color" oninput="updateColorPreview(this.value)" class="w-full bg-slate-800 border border-slate-700 rounded-xl py-3.5 pl-11 pr-4 text-white focus:border-brand-500 outline-none transition">
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-slate-800/50 rounded-2xl border border-slate-700/50 flex justify-between items-center">
                    <span class="text-white font-medium">Quantity in Stock</span>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustModalQty(-1)" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 text-white flex items-center justify-center transition"><i class="fa-solid fa-minus"></i></button>
                        <input type="number" id="item-qty" value="1" class="w-12 bg-transparent text-center text-xl font-bold text-white outline-none" readonly>
                        <button onclick="adjustModalQty(1)" class="w-10 h-10 rounded-full bg-brand-600 hover:bg-brand-500 text-white flex items-center justify-center transition shadow-lg shadow-brand-500/20"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <button onclick="saveItem()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl shadow-xl shadow-brand-500/20 hover:scale-[1.02] transition-transform active:scale-[0.98] mt-2">
                    Save to Inventory
                </button>
                
                <button onclick="deleteItem()" id="btn-delete" class="w-full text-red-400 text-sm font-medium py-2 hover:text-red-300 transition hidden">
                    Delete Item
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[70] bg-black/90 hidden items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-2xl p-6 relative border border-slate-700">
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2"><i class="fa-solid fa-gear text-slate-400"></i> Settings</h3>
            
            <div class="mb-6">
                <label class="block text-brand-400 text-xs font-bold uppercase mb-2">Google Gemini API Key</label>
                <div class="relative">
                    <i class="fa-solid fa-key absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                    <input type="password" id="api-key" placeholder="Paste key starting with AIza..." class="w-full bg-slate-950 border border-slate-700 rounded-lg py-3 pl-10 pr-3 text-white text-sm focus:border-brand-500 outline-none">
                </div>
                <p class="text-xs text-slate-500 mt-2">Required for AI features. Get one free at <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-brand-400 underline hover:text-brand-300">Google AI Studio</a>.</p>
            </div>

            <div class="flex gap-3">
                <button onclick="saveSettings()" class="flex-1 bg-brand-600 text-white py-2.5 rounded-lg font-medium hover:bg-brand-500 transition">Save</button>
                <button onclick="clearData()" class="flex-1 bg-slate-800 border border-slate-700 text-red-400 py-2.5 rounded-lg font-medium hover:bg-slate-700 transition">Reset Data</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. State Management ---
        let inventory = JSON.parse(localStorage.getItem('filamentInventory')) || [];
        let html5QrCode = null;
        let aiStream = null;

        // --- 2. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderInventory();
            updateStats();
            // Load API key if saved
            document.getElementById('api-key').value = localStorage.getItem('geminiApiKey') || '';
        });

        function saveToLocal() {
            localStorage.setItem('filamentInventory', JSON.stringify(inventory));
            updateStats();
            renderInventory();
        }

        function updateStats() {
            const total = inventory.reduce((sum, item) => sum + parseInt(item.qty || 0), 0);
            const lowStock = inventory.filter(item => item.qty <= 2).length;
            
            document.getElementById('total-spools').innerText = total;
            document.getElementById('low-stock-count').innerText = lowStock;
        }

        // --- 3. Rendering UI ---
        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            const search = document.getElementById('search-input').value.toLowerCase();
            
            grid.innerHTML = '';
            
            // Filter logic
            const filtered = inventory.filter(item => 
                (item.brand && item.brand.toLowerCase().includes(search)) || 
                (item.color && item.color.toLowerCase().includes(search)) || 
                (item.type && item.type.toLowerCase().includes(search))
            );

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fa-solid fa-box-open text-slate-600 text-2xl"></i>
                        </div>
                        <p class="text-slate-500 font-medium">No inventory found</p>
                        <p class="text-slate-600 text-sm mt-1">Scan a box to get started</p>
                    </div>`;
                return;
            }

            filtered.forEach(item => {
                const isLow = item.qty <= 2;
                const card = document.createElement('div');
                // Dynamic styling for low stock
                card.className = `glass-panel p-4 rounded-2xl flex justify-between items-center transition-all hover:bg-slate-800/80 ${isLow ? 'border-amber-500/30 bg-amber-500/5' : ''}`;
                
                card.innerHTML = `
                    <div class="flex-1 cursor-pointer" onclick="editItem('${item.id}')">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-white text-lg">${item.brand}</span>
                            <span class="px-2 py-0.5 rounded-md text-[10px] uppercase font-bold bg-slate-700 text-slate-300 tracking-wider">${item.type}</span>
                            ${isLow ? '<i class="fa-solid fa-circle-exclamation text-amber-500 text-sm animate-pulse"></i>' : ''}
                        </div>
                        <div class="text-slate-400 text-sm flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full inline-block shadow-sm" style="background-color: ${getColorHex(item.color)}; border: 1px solid rgba(255,255,255,0.2)"></span>
                            ${item.color}
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-slate-900/50 p-1.5 rounded-xl border border-slate-700/50">
                        <button onclick="updateQty('${item.id}', -1)" class="w-8 h-8 rounded-lg bg-slate-800 text-slate-300 hover:text-white hover:bg-slate-700 flex items-center justify-center transition"><i class="fa-solid fa-minus text-xs"></i></button>
                        <span class="text-lg font-bold w-6 text-center text-white tabular-nums">${item.qty}</span>
                        <button onclick="updateQty('${item.id}', 1)" class="w-8 h-8 rounded-lg bg-brand-600/20 text-brand-400 hover:bg-brand-600 hover:text-white flex items-center justify-center transition"><i class="fa-solid fa-plus text-xs"></i></button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Helper to guess hex color from name
        function getColorHex(colorName) {
            if(!colorName) return '#cbd5e1';
            const ctx = document.createElement('canvas').getContext('2d');
            ctx.fillStyle = colorName.toLowerCase();
            return ctx.fillStyle === '#000000' && colorName.toLowerCase() !== 'black' ? '#cbd5e1' : ctx.fillStyle;
        }

        function updateColorPreview(val) {
            document.getElementById('color-preview').style.backgroundColor = getColorHex(val);
        }

        function filterType(type) {
            const btns = document.querySelectorAll('#filter-chips button');
            btns.forEach(b => {
                b.classList.remove('bg-brand-600', 'text-white');
                b.classList.add('bg-slate-800', 'text-slate-300');
            });
            event.target.classList.remove('bg-slate-800', 'text-slate-300');
            event.target.classList.add('bg-brand-600', 'text-white');
            
            document.getElementById('search-input').value = type === 'all' ? '' : type;
            renderInventory();
        }

        // --- 4. Inventory Logic ---
        function updateQty(id, change) {
            const item = inventory.find(i => i.id === id);
            if (item) {
                item.qty = Math.max(0, parseInt(item.qty) + change);
                saveToLocal();
            }
        }

        function editItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;

            document.getElementById('item-id').value = item.id;
            document.getElementById('item-brand').value = item.brand;
            document.getElementById('item-type').value = item.type;
            document.getElementById('item-color').value = item.color;
            updateColorPreview(item.color);
            document.getElementById('item-qty').value = item.qty;
            
            document.getElementById('modal-title').innerText = 'Edit Filament';
            document.getElementById('btn-delete').classList.remove('hidden');
            
            const modal = document.getElementById('item-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function saveItem() {
            const id = document.getElementById('item-id').value || 'FIL-' + Date.now();
            const brand = document.getElementById('item-brand').value;
            const type = document.getElementById('item-type').value;
            const color = document.getElementById('item-color').value;
            const qty = parseInt(document.getElementById('item-qty').value);

            const newItem = { id, brand, type, color, qty };
            
            const existingIndex = inventory.findIndex(i => i.id === id);
            if (existingIndex >= 0) {
                inventory[existingIndex] = newItem;
            } else {
                inventory.push(newItem);
            }

            saveToLocal();
            closeItemModal();
        }

        function deleteItem() {
            const id = document.getElementById('item-id').value;
            if (confirm("Are you sure you want to delete this item?")) {
                inventory = inventory.filter(i => i.id !== id);
                saveToLocal();
                closeItemModal();
            }
        }

        function closeItemModal() {
            document.getElementById('item-modal').classList.add('hidden');
            document.getElementById('item-modal').classList.remove('flex');
            // Reset form
            document.getElementById('item-id').value = '';
            document.getElementById('item-brand').value = '';
            document.getElementById('item-color').value = '';
            document.getElementById('item-qty').value = 1;
        }

        function adjustModalQty(change) {
            const input = document.getElementById('item-qty');
            input.value = Math.max(0, parseInt(input.value) + change);
        }

        // --- 5. QR Code Scanning ---
        function startQrScanner() {
            document.getElementById('qr-modal').classList.remove('hidden');
            document.getElementById('qr-modal').classList.add('flex');
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    stopQrScanner();
                    handleScan(decodedText);
                },
                (errorMessage) => { /* ignore */ }
            ).catch(err => {
                alert("Camera error: " + err);
                stopQrScanner();
            });
        }

        function stopQrScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById('qr-modal').classList.add('hidden');
                    document.getElementById('qr-modal').classList.remove('flex');
                }).catch(() => {
                    document.getElementById('qr-modal').classList.add('hidden');
                });
            } else {
                document.getElementById('qr-modal').classList.add('hidden');
            }
        }

        function handleScan(code) {
            // Check if item exists
            const item = inventory.find(i => i.id === code);
            if (item) {
                updateQty(item.id, 1);
                // Simple toast notification
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-xl z-[100] animate-[slideDown_0.3s_ease-out] font-bold flex items-center gap-2';
                toast.innerHTML = `<i class="fa-solid fa-check"></i> Added 1 ${item.brand}`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            } else {
                // New item found via QR
                document.getElementById('item-id').value = code;
                document.getElementById('modal-title').innerText = 'New QR Item';
                document.getElementById('btn-delete').classList.add('hidden');
                document.getElementById('item-modal').classList.remove('hidden');
                document.getElementById('item-modal').classList.add('flex');
            }
        }

        // --- 6. AI Vision (The Brain) ðŸ§  ---
        async function openAICamera() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                alert("âš ï¸ Missing API Key\n\nPlease go to Settings (Gear Icon) and paste your Google Gemini API key to use this feature.");
                openSettings();
                return;
            }

            document.getElementById('ai-modal').classList.remove('hidden');
            document.getElementById('ai-modal').classList.add('flex');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                aiStream = stream;
                document.getElementById('ai-video').srcObject = stream;
            } catch (err) {
                console.error("Camera error:", err);
                alert("Could not access camera. Please allow permissions.");
                closeAICamera();
            }
        }

        function closeAICamera() {
            document.getElementById('ai-modal').classList.add('hidden');
            document.getElementById('ai-modal').classList.remove('flex');
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-loading').classList.remove('flex');
            
            if (aiStream) {
                aiStream.getTracks().forEach(track => track.stop());
                aiStream = null;
            }
        }
async function captureAndAnalyze() {
            const video = document.getElementById('ai-video');
            const canvas = document.getElementById('ai-canvas');
            const loading = document.getElementById('ai-loading');

            // Show loading overlay
            loading.classList.remove('hidden');
            loading.classList.add('flex');

            try {
                // 1. Capture and RESIZE Image for Mobile (Max 800px)
                const origWidth = video.videoWidth;
                const origHeight = video.videoHeight;
                const scale = Math.min(1, 800 / origWidth); 
                const newWidth = origWidth * scale;
                const newHeight = origHeight * scale;

                canvas.width = newWidth;
                canvas.height = newHeight;
                canvas.getContext('2d').drawImage(video, 0, 0, newWidth, newHeight);
                
                // 2. Convert to Base64 (remove the "data:image/jpeg;base64," part)
                const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                const apiKey = localStorage.getItem('geminiApiKey');

                // 3. Send to Google Gemini
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "Analyze this image of a 3D printer filament box. Return a JSON object (no markdown) with these keys: 'brand' (string), 'type' (PLA/PETG/ABS etc), 'color' (string). If you cannot find info, use 'Unknown'." },
                                { inlineData: { mimeType: "image/jpeg", data: imageData } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                // 4. Catch specific Google API Errors (like Invalid API Key)
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                // 5. Parse the Brain's Answer
                let text = data.candidates[0].content.parts[0].text;
                // Clean up any markdown ```json ... ``` formatting
                text = text.replace(/```json|```/g, '').trim();
                const result = JSON.parse(text);

                // 6. Fill the Form
                closeAICamera();
                
                document.getElementById('item-brand').value = result.brand || "Unknown";
                document.getElementById('item-color').value = result.color || "Unknown";
                updateColorPreview(result.color || '');
                
                // Try to auto-select type
                const typeSelect = document.getElementById('item-type');
                const aiType = (result.type || "PLA").toUpperCase();
                let foundType = false;
                for(let i=0; i<typeSelect.options.length; i++) {
                    if (aiType.includes(typeSelect.options[i].value)) {
                        typeSelect.selectedIndex = i;
                        foundType = true;
                        break;
                    }
                }
                if(!foundType) typeSelect.value = "Unknown";

                // Open the editor
                document.getElementById('modal-title').innerText = 'âœ¨ AI Found Item';
                document.getElementById('item-id').value = ''; // New ID will be generated
                document.getElementById('btn-delete').classList.add('hidden');
                document.getElementById('item-modal').classList.remove('hidden');
                document.getElementById('item-modal').classList.add('flex');

            } catch (error) {
                console.error(error);
                // Now it will alert the EXACT reason it failed!
                alert("AI Error: " + error.message);
                loading.classList.add('hidden');
                loading.classList.remove('flex');
            }
        }async function captureAndAnalyze() {
            const video = document.getElementById('ai-video');
            const canvas = document.getElementById('ai-canvas');
            const loading = document.getElementById('ai-loading');

            // Show loading overlay
            loading.classList.remove('hidden');
            loading.classList.add('flex');

            try {
                // 1. Capture and RESIZE Image for Mobile (Max 800px)
                const origWidth = video.videoWidth;
                const origHeight = video.videoHeight;
                const scale = Math.min(1, 800 / origWidth); 
                const newWidth = origWidth * scale;
                const newHeight = origHeight * scale;

                canvas.width = newWidth;
                canvas.height = newHeight;
                canvas.getContext('2d').drawImage(video, 0, 0, newWidth, newHeight);
                
                // 2. Convert to Base64 (remove the "data:image/jpeg;base64," part)
                const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                const apiKey = localStorage.getItem('geminiApiKey');

                // 3. Send to Google Gemini
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "Analyze this image of a 3D printer filament box. Return a JSON object (no markdown) with these keys: 'brand' (string), 'type' (PLA/PETG/ABS etc), 'color' (string). If you cannot find info, use 'Unknown'." },
                                { inlineData: { mimeType: "image/jpeg", data: imageData } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                // 4. Catch specific Google API Errors (like Invalid API Key)
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                // 5. Parse the Brain's Answer
                let text = data.candidates[0].content.parts[0].text;
                // Clean up any markdown ```json ... ``` formatting
                text = text.replace(/```json|```/g, '').trim();
                const result = JSON.parse(text);

                // 6. Fill the Form
                closeAICamera();
                
                document.getElementById('item-brand').value = result.brand || "Unknown";
                document.getElementById('item-color').value = result.color || "Unknown";
                updateColorPreview(result.color || '');
                
                // Try to auto-select type
                const typeSelect = document.getElementById('item-type');
                const aiType = (result.type || "PLA").toUpperCase();
                let foundType = false;
                for(let i=0; i<typeSelect.options.length; i++) {
                    if (aiType.includes(typeSelect.options[i].value)) {
                        typeSelect.selectedIndex = i;
                        foundType = true;
                        break;
                    }
                }
                if(!foundType) typeSelect.value = "Unknown";

                // Open the editor
                document.getElementById('modal-title').innerText = 'âœ¨ AI Found Item';
                document.getElementById('item-id').value = ''; // New ID will be generated
                document.getElementById('btn-delete').classList.add('hidden');
                document.getElementById('item-modal').classList.remove('hidden');
                document.getElementById('item-modal').classList.add('flex');

            } catch (error) {
                console.error(error);
                // Now it will alert the EXACT reason it failed!
                alert("AI Error: " + error.message);
                loading.classList.add('hidden');
                loading.classList.remove('flex');
            }
        }
       


        // --- 7. Settings & Utils ---
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('settings-modal').classList.add('flex');
        }

        function saveSettings() {
            const key = document.getElementById('api-key').value.trim();
            localStorage.setItem('geminiApiKey', key);
            document.getElementById('settings-modal').classList.add('hidden');
            alert("Settings Saved!");
        }

        function clearData() {
            if(confirm("Are you sure? This will delete all inventory.")) {
                localStorage.removeItem('filamentInventory');
                inventory = [];
                renderInventory();
                updateStats();
                document.getElementById('settings-modal').classList.add('hidden');
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventory));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "filament_inventory.json");
            dlAnchorElem.click();
        }

        // Styles for animations
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
            @keyframes slideDown { from { transform: translateY(-100%) translateX(-50%); opacity: 0; } to { transform: translateY(0) translateX(-50%); opacity: 1; } }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
