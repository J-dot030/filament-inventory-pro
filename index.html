<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Filament — Inventory</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0e0e0f; --surface: #161618; --surface-2: #1e1e21; --border: rgba(255,255,255,0.07);
            --border-strong: rgba(255,255,255,0.13); --text: #f0f0f0; --text-2: #888; --text-3: #555;
            --accent: #e8ff48; --accent-dim: rgba(232,255,72,0.12); --danger: #ff4f4f; --danger-dim: rgba(255,79,79,0.1);
            --amber: #ffb347; --amber-dim: rgba(255,179,71,0.1);
        }
        html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        .app { display: flex; flex-direction: column; min-height: 100vh; }
        header { position: sticky; top: 0; z-index: 40; background: rgba(14,14,15,0.92); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); padding: 0 20px; height: 56px; display: flex; align-items: center; justify-content: space-between; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-mark { width: 28px; height: 28px; border: 1.5px solid var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; position: relative; }
        .logo-mark::before { content: ''; width: 10px; height: 10px; background: var(--accent); border-radius: 2px; }
        .logo-text { font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 500; letter-spacing: 0.08em; color: var(--text); }
        .logo-text span { color: var(--text-3); }
        .header-actions { display: flex; gap: 4px; }
        .icon-btn { width: 36px; height: 36px; border-radius: 8px; border: none; background: transparent; color: var(--text-2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 15px; }
        main { flex: 1; padding: 24px 20px 120px; max-width: 640px; margin: 0 auto; width: 100%; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 18px 20px; position: relative; overflow: hidden; }
        .stat-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.1em; color: var(--text-3); text-transform: uppercase; margin-bottom: 10px; }
        .stat-value { font-family: 'DM Mono', monospace; font-size: 36px; font-weight: 300; color: var(--text); line-height: 1; }
        .stat-value.warn { color: var(--amber); }
        .search-wrap { position: relative; margin-bottom: 16px; }
        .search-input { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 11px 14px; color: var(--text); outline: none; }
        .group-container { margin-bottom: 12px; }
        .group-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; }
        .group-title { font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 10px;}
        .group-badge { font-family: 'DM Mono', monospace; font-size: 11px; background: var(--surface); color: var(--text-2); padding: 2px 8px; border-radius: 12px; border: 1px solid var(--border); }
        .group-content { display: none; flex-direction: column; gap: 4px; padding-top: 8px; margin-left: 4px; }
        .group-content.open { display: flex; }
        .item-row { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; display: flex; align-items: center; gap: 14px; cursor: pointer; }
        .item-row.low { border-color: rgba(255,179,71,0.25); background: var(--amber-dim); }
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-size: 13px; font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 6px; }
        .item-id-badge { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--accent); background: var(--accent-dim); padding: 1px 6px; border-radius: 4px;}
        .qty-control { display: flex; align-items: center; gap: 8px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface-2); color: var(--text-2); cursor: pointer; border: none; }
        .fab-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 30; padding: 16px 20px 28px; background: linear-gradient(to top, var(--bg) 60%, transparent); display: flex; justify-content: center; }
        .fab.primary { flex: 1; max-width: 280px; padding: 14px; border-radius: 12px; background: var(--accent); color: #0e0e0f; font-weight: 600; border: none; cursor: pointer; }
        .modal-overlay { position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,0.75); backdrop-filter: blur(6px); display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-sheet { background: var(--surface); width: 100%; max-width: 640px; padding: 28px 24px 40px; border-radius: 20px 20px 0 0; position: relative; }
        .field-group { margin-bottom: 16px; }
        .field-label { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text-3); text-transform: uppercase; margin-bottom: 6px; }
        .field-input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 11px 14px; color: var(--text); outline: none; }
        .camera-modal { position: fixed; inset: 0; z-index: 60; background: #000; display: none; flex-direction: column; }
        #ai-video { width: 100%; height: 100%; object-fit: cover; }
        .ai-loading { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; color: white; z-index: 100; }
        .ai-loading.show { display: flex; }
        .sync-badge { font-family: 'DM Mono'; font-size: 10px; background: rgba(74, 222, 128, 0.1); color: #4ade80; padding: 4px 8px; border-radius: 12px; border: 1px solid rgba(74, 222, 128, 0.3); display: flex; align-items: center; gap: 4px;}
    </style>
</head>
<body>
<div class="app">
    <header>
        <div class="logo"><div class="logo-mark"></div><span class="logo-text">FILAMENT<span>/INV</span></span></div>
        <div class="header-actions"><div class="sync-badge">Sync Active</div><button class="icon-btn" onclick="openSettings()">⚙️</button></div>
    </header>
    <main>
        <div class="stats-row">
            <div class="stat-card"><div class="stat-label">Total Spools</div><div class="stat-value" id="total-spools">0</div></div>
            <div class="stat-card"><div class="stat-label">Low Stock</div><div class="stat-value warn" id="low-stock-count">0</div></div>
        </div>
        <div class="search-wrap"><input type="text" class="search-input" id="search-input" onkeyup="renderInventory()" placeholder="Search brand, ID, material…"></div>
        <div id="inventory-grid"></div>
    </main>
    <div class="fab-bar"><button class="fab primary" onclick="openAICamera()">✨ AI Scan</button></div>
</div>

<div class="camera-modal" id="ai-modal">
    <div style="position:absolute; top:20px; width:100%; padding:0 20px; display:flex; justify-content:space-between; z-index:10;">
        <span style="color:white; font-family:monospace;">AI SCANNER</span><button onclick="closeAICamera()" style="background:none; border:none; color:white; font-size:24px;">✕</button>
    </div>
    <video id="ai-video" autoplay playsinline></video>
    <canvas id="ai-canvas" style="display:none;"></canvas>
    <div style="position:absolute; bottom:40px; width:100%; display:flex; justify-content:center;">
        <button onclick="captureAndAnalyze()" style="width:70px; height:70px; border-radius:50%; border:5px solid white; background:rgba(255,255,255,0.2); cursor:pointer;"></button>
    </div>
    <div class="ai-loading" id="ai-loading">ANALYZING...</div>
</div>

<div class="modal-overlay" id="item-modal">
    <div class="modal-sheet">
        <button onclick="closeItemModal()" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white;">✕</button>
        <h3 style="margin-bottom:20px;">Edit Spool</h3>
        <div class="field-group"><div class="field-label">ID</div><input type="text" id="item-id" class="field-input"></div>
        <div class="field-group"><div class="field-label">Brand</div><input type="text" id="item-brand" class="field-input"></div>
        <div class="field-group"><div class="field-label">Color</div><input type="text" id="item-color" class="field-input"></div>
        <div class="field-group"><div class="field-label">Material</div>
            <select id="item-type" class="field-input" style="background:#0e0e0f; color:white; border:1px solid var(--border);">
                <option value="PLA">PLA</option><option value="PETG">PETG</option><option value="ASA">ASA</option><option value="ABS">ABS</option><option value="TPU">TPU</option>
            </select>
        </div>
        <div class="field-group"><div class="field-label">Remaining %</div>
            <div style="display:flex; align-items:center; gap:20px; justify-content:center;">
                <button class="qty-btn" onclick="adjustModalQty(-10)" style="width:40px; height:40px; background:var(--surface-2); color:white; border-radius:8px;">-</button>
                <input type="number" id="item-qty" style="background:none; border:none; color:white; font-size:24px; width:60px; text-align:center;" readonly>
                <button class="qty-btn" onclick="adjustModalQty(10)" style="width:40px; height:40px; background:var(--surface-2); color:white; border-radius:8px;">+</button>
            </div>
        </div>
        <button class="fab primary" onclick="saveItem()" style="width:100%; margin-top:20px;">Save to Inventory</button>
        <button onclick="deleteItem()" style="width:100%; margin-top:10px; background:none; border:none; color:var(--danger); font-size:12px; cursor:pointer;">Delete Spool</button>
    </div>
</div>

<script>
    const HARDCODED_GEMINI_KEY = ""; 
    let inventory = JSON.parse(localStorage.getItem('filamentInventory')) || [];
    let aiStream = null;

    function renderInventory() {
        const grid = document.getElementById('inventory-grid');
        const search = (document.getElementById('search-input').value || "").toLowerCase();
        grid.innerHTML = '';
        
        const filtered = inventory.filter(i => ( (i.brand||"") + (i.id||"") + (i.type||"") ).toLowerCase().includes(search));
        const grouped = {};
        
        filtered.forEach(item => {
            const mat = (item.type || 'PLA').toUpperCase();
            if (!grouped[mat]) grouped[mat] = [];
            grouped[mat].push(item);
        });

        Object.keys(grouped).sort().forEach(mat => {
            const items = grouped[mat];
            const container = document.createElement('div');
            container.className = 'group-container';
            container.innerHTML = `
                <div class="group-header" onclick="this.nextElementSibling.classList.toggle('open')">
                    <div class="group-title">${mat} <span class="group-badge">${items.length}</span></div>
                    <div style="color:#555;">▼</div>
                </div>
                <div class="group-content open"></div>
            `;
            const content = container.querySelector('.group-content');
            items.forEach(i => {
                const row = document.createElement('div');
                row.className = 'item-row' + (i.qty <= 20 ? ' low' : '');
                row.onclick = () => editItem(i.id);
                row.innerHTML = `
                    <div class="item-info">
                        <div class="item-name"><span class="item-id-badge">${i.id}</span> ${i.brand}</div>
                        <div style="color:#555; font-size:11px; margin-top:4px;">Color: ${i.color}</div>
                    </div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="event.stopPropagation(); updateQty('${i.id}',-10)">-</button>
                        <span style="font-family:monospace; min-width:35px; text-align:center;">${i.qty}%</span>
                        <button class="qty-btn" onclick="event.stopPropagation(); updateQty('${i.id}',10)">+</button>
                    </div>
                `;
                content.appendChild(row);
            });
            grid.appendChild(container);
        });
        updateStats();
    }

    function updateStats() {
        document.getElementById('total-spools').textContent = inventory.length;
        document.getElementById('low-stock-count').textContent = inventory.filter(i => i.qty <= 20).length;
    }

    async function openAICamera() {
        const modal = document.getElementById('ai-modal');
        modal.style.display = 'flex';
        try {
            aiStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('ai-video').srcObject = aiStream;
        } catch (e) { alert("Camera error: " + e.message); closeAICamera(); }
    }

    function closeAICamera() {
        document.getElementById('ai-modal').style.display = 'none';
        if (aiStream) aiStream.getTracks().forEach(t => t.stop());
    }

    async function captureAndAnalyze() {
        const loading = document.getElementById('ai-loading');
        loading.classList.add('show');
        const video = document.getElementById('ai-video');
        const canvas = document.getElementById('ai-canvas');
        canvas.width = 800; canvas.height = 600;
        canvas.getContext('2d').drawImage(video, 0, 0, 800, 600);
        const base64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
        const key = HARDCODED_GEMINI_KEY || localStorage.getItem('geminiApiKey');
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST', body: JSON.stringify({ contents: [{ parts: [
                    { text: "Return JSON only: brand, color, type (PLA/PETG/ASA/ABS/TPU), spool_id (the number written in Sharpie), percentage_left (0-100 estimate)." },
                    { inlineData: { mimeType: "image/jpeg", data: base64 } }
                ]}]})
            });
            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            const result = JSON.parse(text);
            closeAICamera();
            document.getElementById('item-id').value = result.spool_id || 'NEW';
            document.getElementById('item-brand').value = result
