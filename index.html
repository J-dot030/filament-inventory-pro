<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Filament Commander — Print Farm OS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0a0a0b; --surface: #141416; --surface-2: #1c1c1f; --border: rgba(255,255,255,0.06);
            --text: #ffffff; --text-dim: #a1a1aa; --accent: #00f2ff; --accent-dim: rgba(0,242,255,0.1);
            --danger: #ff4b4b; --success: #4ade80; --warning: #fbbf24;
        }
        html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; -webkit-font-smoothing: antialiased; }
        .app { display: flex; flex-direction: column; min-height: 100vh; max-width: 600px; margin: 0 auto; border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
        
        header { position: sticky; top: 0; z-index: 50; background: rgba(10,10,11,0.8); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; }
        .logo { display: flex; align-items: center; gap: 8px; font-weight: 700; color: var(--accent); }
        .user-badge { font-family: 'DM Mono'; font-size: 10px; background: var(--surface-2); padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border); color: var(--text-dim); cursor: pointer;}

        main { flex: 1; padding: 20px; padding-bottom: 120px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .stat-box { background: var(--surface); padding: 16px; border-radius: 16px; border: 1px solid var(--border); }
        .stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
        .stat-val { font-family: 'DM Mono'; font-size: 24px; color: var(--text); }

        .tool-bar { margin-bottom: 20px; }
        .search-input { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; color: white; outline: none; }
        .search-input:focus { border-color: var(--accent); }

        .group-container { margin-bottom: 20px; }
        .group-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 4px; color: var(--accent); font-size: 12px; font-weight: 700; border-bottom: 1px solid var(--accent-dim); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.1em;}
        .group-header.low-stock { color: var(--warning); border-color: rgba(251, 191, 36, 0.3); }

        .spool-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 6px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
        .spool-card:active { transform: scale(0.98); background: var(--surface-2); }
        .id-pill { font-family: 'DM Mono'; background: var(--accent-dim); color: var(--accent); padding: 4px 8px; border-radius: 6px; font-size: 13px; font-weight: 700; min-width: 50px; text-align: center; }
        .spool-info { flex: 1; min-width: 0; }
        .spool-brand { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .spool-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        
        .weight-pill { font-family: 'DM Mono'; text-align: right; }
        .weight-val { font-size: 16px; font-weight: 700; }
        .weight-label { font-size: 9px; color: var(--text-dim); }

        .fab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 600px; padding: 20px; background: linear-gradient(transparent, var(--bg) 40%); display: flex; }
        .btn-scan { flex: 1; background: var(--accent); color: var(--bg); border: none; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 8px 24px rgba(0,242,255,0.2); }

        .camera-overlay { position: fixed; inset: 0; z-index: 100; background: #000; display: none; flex-direction: column; }
        #ai-video { flex: 1; object-fit: cover; }
        .shutter { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 72px; height: 72px; border: 4px solid white; border-radius: 50%; background: rgba(255,255,255,0.2); cursor: pointer; }
        .ai-status { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; color: var(--accent); font-family: 'DM Mono'; z-index: 110; text-align: center; }

        .modal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; align-items: flex-end; justify-content: center; }
        .modal.open { display: flex; }
        .modal-sheet { background: var(--surface); width: 100%; max-width: 500px; padding: 24px; border-radius: 24px 24px 0 0; border: 1px solid var(--border); }
        .input-group { margin-bottom: 16px; }
        .label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 6px; font-weight: 700; display: block; }
        .input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px; color: white; font-size: 16px; outline: none; }
        .btn-save { width: 100%; background: var(--accent); color: var(--bg); padding: 16px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-top: 10px;}
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 300; background: var(--accent); color: black; padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: none;}
    </style>
</head>
<body>
<div class="app">
    <header>
        <div class="logo">⚡ FILAMENT COMMANDER</div>
        <div class="user-badge" id="current-user" onclick="switchUser()">Member 1</div>
    </header>

    <main>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Total Inventory</div>
                <div class="stat-val" id="total-weight">0<span style="font-size: 12px; color: var(--text-dim)">kg</span></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Unique Assets</div>
                <div class="stat-val" id="active-count">0</div>
            </div>
        </div>

        <div class="tool-bar">
            <input type="text" class="search-input" id="search-input" onkeyup="renderInventory()" placeholder="Find ID, Brand, or Color...">
        </div>

        <div id="inventory-grid"></div>
    </main>

    <div class="fab-bar">
        <button class="btn-scan" onclick="openAICamera()">✨ AI SMART SCAN</button>
    </div>
</div>

<div id="hint-toast" class="toast"></div>

<div class="camera-overlay" id="ai-modal">
    <div style="position:absolute; top:20px; width:100%; padding:0 20px; display:flex; justify-content:space-between; z-index:10;">
        <span style="font-family: 'DM Mono'; font-size: 10px; color:var(--accent);">HIERARCHY: FACTORY ID > SHARPIE ID</span>
        <button onclick="closeAICamera()" style="background:none; border:none; color:white; font-size:24px;">✕</button>
    </div>
    <video id="ai-video" autoplay playsinline></video>
    <canvas id="ai-canvas" style="display:none;"></canvas>
    <div class="shutter" onclick="captureAndAnalyze()"></div>
    <div class="ai-status" id="ai-loading">
        <div>
            <div style="font-size: 24px; margin-bottom: 10px; font-weight: bold;">ANALYZING...</div>
            <div style="color:var(--text-dim); font-size:11px;">Identifying Serial or Asset ID</div>
        </div>
    </div>
</div>

<div class="modal" id="item-modal">
    <div class="modal-sheet">
        <h3 id="modal-title" style="margin-bottom:20px; font-size:18px;">Sync Spool Asset</h3>
        
        <div class="input-group">
            <label class="label">Identification (Serial / Sharpie #)</label>
            <input type="text" id="item-id" class="input">
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div class="input-group">
                <label class="label">Brand</label>
                <input type="text" id="item-brand" class="input">
            </div>
            <div class="input-group">
                <label class="label">Material</label>
                <select id="item-type" class="input">
                    <option value="PLA">PLA</option><option value="PETG">PETG</option><option value="ASA">ASA</option><option value="ABS">ABS</option><option value="TPU">TPU</option>
                </select>
            </div>
        </div>

        <div class="input-group">
            <label class="label">Color / Finish</label>
            <input type="text" id="item-color" class="input">
        </div>

        <div class="input-group">
            <label class="label">Remaining Weight (grams)</label>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="addWeight(-100)" style="flex:1; padding:12px; background:var(--surface-2); border:none; color:white; border-radius:10px;">-100g</button>
                <input type="number" id="item-weight" class="input" style="flex:1.5; text-align:center; font-family:'DM Mono';">
                <button onclick="addWeight(100)" style="flex:1; padding:12px; background:var(--surface-2); border:none; color:white; border-radius:10px;">+100g</button>
            </div>
        </div>

        <button class="btn-save" onclick="saveItem()">SAVE & SYNC</button>
        <button onclick="deleteItem()" style="width:100%; margin-top:20px; background:none; border:none; color:var(--danger); font-size:11px; cursor:pointer; font-weight:bold;">REMOVE ASSET PERMANENTLY</button>
    </div>
</div>

<script>
    // --- CONNECT GOOGLE SHEETS LATER HERE ---
    const GEMINI_KEY = ""; // PASTE KEY HERE
    
    let inventory = JSON.parse(localStorage.getItem('filamentFarmDB')) || [];
    let activeUser = localStorage.getItem('activeUser') || "Member 1";
    let aiStream = null;

    document.getElementById('current-user').textContent = activeUser;

    function renderInventory() {
        const grid = document.getElementById('inventory-grid');
        const search = document.getElementById('search-input').value.toLowerCase();
        grid.innerHTML = '';
        
        const filtered = inventory.filter(i => (i.id + i.brand + i.type + i.color).toLowerCase().includes(search));
        const grouped = {};
        
        filtered.forEach(i => {
            if (!grouped[i.type]) grouped[i.type] = [];
            grouped[i.type].push(i);
        });

        let totalGrams = 0;
        Object.keys(grouped).sort().forEach(type => {
            let groupWeight = 0;
            const spoolCount = grouped[type].length;
            const isLowStock = spoolCount < 3; // <--- The NEW Logic you requested
            
            const container = document.createElement('div');
            container.className = 'group-container';
            
            const listContainer = document.createElement('div');
            
            grouped[type].forEach(i => {
                groupWeight += parseInt(i.weight || 0);
                totalGrams += parseInt(i.weight || 0);
                const card = document.createElement('div');
                card.className = 'spool-card';
                card.onclick = () => editItem(i.id);
                card.innerHTML = `
                    <div class="id-pill">#${i.id}</div>
                    <div class="spool-info">
                        <div class="spool-brand">${i.brand}</div>
                        <div class="spool-meta">${i.color} • ${i.user}</div>
                    </div>
                    <div class="weight-pill">
                        <div class="weight-val" style="color: ${i.weight < 250 ? 'var(--danger)' : 'white'}">${i.weight}g</div>
                        <div class="weight-label">LEFT</div>
                    </div>
                `;
                listContainer.appendChild(card);
            });

            // Dynamic header based on spool count
            container.innerHTML = `<div class="group-header ${isLowStock ? 'low-stock' : ''}">
                <span>${type} ${isLowStock ? '<span style="color:var(--danger); font-size:10px; margin-left:6px;">⚠️ &lt; 3 SPOOLS</span>' : ''}</span>
                <span>${spoolCount} Spools (${(groupWeight/1000).toFixed(1)}kg)</span>
            </div>`;
            
            container.appendChild(listContainer);
            grid.appendChild(container);
        });

        document.getElementById('total-weight').innerHTML = `${(totalGrams/1000).toFixed(1)}<span style="font-size: 12px; color: var(--text-dim)">kg</span>`;
        document.getElementById('active-count').textContent = inventory.length;
    }

    function getNextId() {
        const nums = inventory.map(i => parseInt(i.id)).filter(n => !isNaN(n));
        return nums.length === 0 ? "001" : (Math.max(...nums) + 1).toString().padStart(3, '0');
    }

    async function openAICamera() {
        const next = getNextId();
        const toast = document.getElementById('hint-toast');
        toast.style.display = 'block';
        toast.innerHTML = `IF NO FACTORY SERIAL: WRITE #${next}`;
        setTimeout(() => toast.style.display = 'none', 5000);

        document.getElementById('ai-modal').style.display = 'flex';
        aiStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('ai-video').srcObject = aiStream;
    }

    async function captureAndAnalyze() {
        document.getElementById('ai-loading').style.display = 'flex';
        const canvas = document.getElementById('ai-canvas');
        const video = document.getElementById('ai-video');
        canvas.width = 800; canvas.height = 600;
        canvas.getContext('2d').drawImage(video, 0, 0, 800, 600);
        const base64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY || localStorage.getItem('geminiApiKey')}`, {
                method: 'POST', body: JSON.stringify({ contents: [{ parts: [
                    { text: "Analyze 3D spool image. PRIORITY: 1. Find printed factory serial number on label. 2. If no factory serial, find handwritten Sharpie number. 3. If neither, return null for asset_id. Return JSON: brand, color, type (PLA/PETG/ASA/ABS/TPU), asset_id (string), weight_estimate (number 0-1000)." },
                    { inlineData: { mimeType: "image/jpeg", data: base64 } }
                ]}]})
            });
            const data = await res.json();
            const result = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ''));
            
            closeAICamera();
            document.getElementById('item-id').value = result.asset_id && result.asset_id !== "null" ? result.asset_id : getNextId();
            document.getElementById('item-brand').value = result.brand;
            document.getElementById('item-color').value = result.color;
            document.getElementById('item-weight').value = result.weight_estimate || 1000;
            document.getElementById('item-type').value = result.type || 'PLA';
            document.getElementById('item-modal').classList.add('open');
        } catch (e) { 
            alert("AI Scan failed. Manual entry opened."); 
            closeAICamera();
            document.getElementById('item-id').value = getNextId(); 
            document.getElementById('item-modal').classList.add('open'); 
        }
        document.getElementById('ai-loading').style.display = 'none';
    }

    function saveItem() {
        const id = document.getElementById('item-id').value;
        const newItem = {
            id, brand: document.getElementById('item-brand').value,
            color: document.getElementById('item-color').value,
            weight: document.getElementById('item-weight').value,
            type: document.getElementById('item-type').value,
            user: activeUser,
            time: new Date().toISOString()
        };
        const idx = inventory.findIndex(i => i.id === id);
        if (idx >= 0) inventory[idx] = newItem; else inventory.push(newItem);
        localStorage.setItem('filamentFarmDB', JSON.stringify(inventory));
        closeItemModal(); renderInventory();
    }

    function editItem(id) {
        const i = inventory.find(x => x.id === id);
        document.getElementById('item-id').value = i.id;
        document.getElementById('item-brand').value = i.brand;
        document.getElementById('item-color').value = i.color;
        document.getElementById('item-weight').value = i.weight;
        document.getElementById('item-type').value = i.type;
        document.getElementById('modal-title').textContent = "Asset Details #" + i.id;
        document.getElementById('item-modal').classList.add('open');
    }

    function addWeight(d) {
        const el = document.getElementById('item-weight');
        el.value = Math.max(0, parseInt(el.value || 0) + d);
    }

    function switchUser() {
        const u = prompt("Team Member Name:", activeUser);
        if (u) { activeUser = u; localStorage.setItem('activeUser', u); document.getElementById('current-user').textContent = u; renderInventory(); }
    }

    function closeAICamera() { document.getElementById('ai-modal').style.display = 'none'; if(aiStream) aiStream.getTracks().forEach(t => t.stop()); }
    function closeItemModal() { document.getElementById('item-modal').classList.remove('open'); }
    function deleteItem() { if(confirm("Permanently delete this asset?")) { inventory = inventory.filter(i => i.id !== document.getElementById('item-id').value); localStorage.setItem('filamentFarmDB', JSON.stringify(inventory)); closeItemModal(); renderInventory(); } }
    
    // Auto-ask for Key on first load if missing
    if(!GEMINI_KEY && !localStorage.getItem('geminiApiKey')) {
        const k = prompt("Welcome! Please enter your Gemini API Key to enable scanning:");
        if(k) localStorage.setItem('geminiApiKey', k);
    }

    renderInventory();
</script>
</body>
</html>
